<div dir="ltr" style="text-align: left;">

## â“ Q16:

## How exactly does Virtual Method Table (VMT) and Dispatch Mechanism work?

### âœ… Deep Answer:

Each class with virtual methods has a **VMT** that is used for method dispatch at runtime.

### ğŸ” VMT Structure:

<div dir="ltr" style="text-align: left;">

```csharp
class Base {
    public virtual void Method1() { }
    public virtual void Method2() { }
    public void Method3() { }  // Non-virtual
}

class Derived : Base {
    public override void Method1() { }  // Override
    // Method2 not overridden
    public new void Method3() { }  // Hiding
}
```

<div dir="ltr" style="text-align: left;">

### ğŸ“Š VMT Layout:

<div dir="ltr" style="text-align: left;">

```
Base VMT:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [0] Base.Method1()  â”‚ â†’ Address: 0x1000
â”‚ [1] Base.Method2()  â”‚ â†’ Address: 0x2000
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Derived VMT:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [0] Derived.Method1()â”‚ â†’ Address: 0x3000 (Overridden)
â”‚ [1] Base.Method2()   â”‚ â†’ Address: 0x2000 (Inherited from Base)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

<div dir="ltr" style="text-align: left;">

### âš™ï¸ Dispatch Mechanism:

<div dir="ltr" style="text-align: left;">

```csharp
Base obj = new Derived();
obj.Method1();  // What happens?

// 1. Runtime reads actual type: Derived
// 2. Goes to Derived VMT
// 3. Reads index [0] (Method1)
// 4. Jumps to address 0x3000 â†’ Derived.Method1() executes
```

<div dir="ltr" style="text-align: left;">

### ğŸ”¬ Implementation Details:

- **VMT Pointer** is stored in Object Header (8 bytes)
- Each class has only **one VMT** (shared among all instances)
- **Indices** are based on the order of virtual method definitions
- If method is not overridden, VMT points to Base method

### âš¡ Performance:

- Virtual Call = 2-3 CPU cycles (VMT lookup)
- Direct Call = 1 CPU cycle (direct jump)

### ğŸ¯ Advanced Note:

JIT Compiler can perform **Devirtualization** in some cases and convert virtual call to direct call (if type is known at compile-time).
